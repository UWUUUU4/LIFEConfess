<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Anonymous Mail to LCA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input {
            background-color: #f8f7ff;
            border-color: #e6e6e6;
        }
        .form-input:focus {
            border-color: #ff77a9;
            box-shadow: 0 0 0 2px #ffb3c6;
            outline: none;
        }
        .btn-primary {
            background-color: #ff77a9;
            color: white;
        }
        .btn-primary:hover {
            background-color: #ff69b4;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-pink-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full">
        
        <h1 class="text-3xl font-bold text-center text-pink-500 mb-4">
            Send Anonymous Mail
        </h1>
        <p class="text-center text-gray-500 mb-6">
            This message will be sent to the owner of this link.
        </p>
        
        <!-- The Form -->
        <div class="space-y-4">
            <textarea id="messageText" class="w-full h-40 p-4 rounded-lg shadow-sm focus:ring-2 form-input" placeholder="Write your message..."></textarea>
            
            <!-- NEW: Clue Field -->
            <input id="clueText" type="text" class="w-full p-4 rounded-lg shadow-sm focus:ring-2 form-input" placeholder="Add a Clue (Optional, can be revealed!)" />
            
            <button id="sendButton" class="w-full font-bold py-3 px-4 rounded-lg shadow-md btn-primary transition duration-300">
                Send Mail
            </button>
        </div>

        <div id="messageBox" class="hidden mt-4 p-4 rounded-lg">
            <p id="messageBoxText" class="font-medium text-center"></p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- PASTE YOUR 'confessapp-e1aff' KEYS HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCzRIRSuwYKPdbdIrYFUV3Yuqyl0hcU0Fk",
          authDomain: "confessapp-e1aff.firebaseapp.com",
          projectId: "confessapp-e1aff",
          storageBucket: "confessapp-e1aff.firebasestorage.app",
          messagingSenderId: "1036012328977",
          appId: "1:1036012328977:web:a9df29ebf930147fe979b0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        const sendButton = document.getElementById('sendButton');
        const messageText = document.getElementById('messageText');
        const clueText = document.getElementById('clueText'); // <-- NEW
        const messageBox = document.getElementById('messageBox');
        const messageBoxText = document.getElementById('messageBoxText');

        sendButton.onclick = async () => {
            if (!userId) {
                showMessage("ERROR: No user ID found in the link.", "error");
                return;
            }

            const text = messageText.value.trim();
            const clue = clueText.value.trim(); // <-- NEW
            
            if (text === "") {
                showMessage("You can't send an empty message.", "error");
                return;
            }

            sendButton.disabled = true;
            sendButton.innerText = "Sending...";

            try {
                const messagesRef = db.collection("users").doc(userId).collection("messages");

                // --- NEW PAYLOAD ---
                let payload = {
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false,
                    hasClue: false // Default to false
                };

                // If they added a clue, update the payload
                if (clue !== "") {
                    payload.hasClue = true;
                    payload.clueText = clue;
                }

                await messagesRef.add(payload);

                showMessage("Mail sent successfully!", "success");
                messageText.value = "";
                clueText.value = ""; // Clear both boxes

            } catch (error) {
                console.error("Error sending message: ", error);
                showMessage("An error occurred. Please try again.", "error");
            } finally {
                sendButton.disabled = false;
                sendButton.innerText = "Send Mail";
            }
        };

        function showMessage(text, type) {
            messageBoxText.innerText = text;
            if (type === "success") {
                messageBox.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-800";
            } else {
                messageBox.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-800";
            }
            messageBox.classList.remove('hidden');
        }
    </script>
</body>
</html>
