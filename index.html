<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Anonymous Mail to LCA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #FFF7F9;
        }
        #sendMailContainer, #checkReplyContainer {
            position: relative;
        }
        .form-input {
            background-color: #fff; border: none; width: 100%;
            padding: 1rem; line-height: 1.6; font-size: 16px; color: #4a4a4a;
            font-family: 'Inter', sans-serif;
        }
        .form-input:focus { box-shadow: none; outline: none; }
        .clue-input {
             background-color: #f8f7ff; border: 1px solid #e6e6e6;
             font-family: 'Inter', sans-serif;
        }
        .clue-input:focus {
            border-color: #ff77a9; box-shadow: 0 0 0 2px #ffb3c6; outline: none;
        }
        .btn-primary {
            background-color: #ff77a9; color: white;
        }
        .btn-secondary {
            background-color: #e6e6e6; color: #4a4a4a;
        }
        .watermark {
            position: absolute; bottom: 10px; right: 15px; font-size: 1.5rem;
            font-weight: bold; color: #e6e6e6; opacity: 0.5;
            transform: rotate(-15deg); pointer-events: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Send Mail Container -->
    <div id="sendMailContainer" class="bg-white p-6 rounded-2xl shadow-lg max-w-md w-full hidden">
        <div class="bg-pink-50 rounded-lg border border-pink-100 overflow-hidden mb-4">
            <div id="letterHeader" class="bg-pink-400 p-4">
                <p id="headerText" class="text-white text-center font-bold text-lg tracking-wider">
                    tell me anything
                </p>
            </div>
            <div class="bg-white p-4 relative">
                <textarea id="messageText" class="w-full h-40 form-input resize-none" placeholder="Write your message..."></textarea>
                <div class="watermark">LCA</div>
            </div>
        </div>
        <div class="space-y-4">
            <input id="clueText" type="text" class="w-full p-4 rounded-lg shadow-sm clue-input" placeholder="Add a Clue (Optional, can be revealed!)" />
            <input id="replyPassword" type="text" class="w-full p-4 rounded-lg shadow-sm clue-input" placeholder="Create a secret password to check for a reply..." />
            
            <button id="aiButton" class="w-full font-bold py-3 px-4 rounded-lg shadow-md btn-secondary transition duration-300 flex items-center justify-center">
                <svg id="aiButtonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v1.23c-2.39.42-4.28 2.3-4.7 4.69A5 5 0 0010 15v1.23c2.39-.42 4.28 2.3 4.7-4.69A5 5 0 0010 3zm0 2a3 3 0 100 6 3 3 0 000-6zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                <svg id="aiButtonLoading" class="hidden animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="aiButtonText">Get AI Question</span>
            </button>
            <button id="sendButton" class="w-full font-bold py-3 px-4 rounded-lg shadow-md btn-primary transition duration-300">
                Send Mail
            </button>
            <button id="showCheckReplyButton" class="w-full font-bold py-2 px-4 rounded-lg text-gray-500 transition duration-300 hover:bg-gray-100">
                Check for a Reply?
            </button>
        </div>
    </div>

    <!-- Check Reply Container -->
    <div id="checkReplyContainer" class="bg-white p-6 rounded-2xl shadow-lg max-w-md w-full hidden">
        <h1 class="text-3xl font-bold text-center text-pink-500 mb-4">Check for Reply</h1>
        <p class="text-center text-gray-500 mb-6">Enter the secret password you created to see if you got a reply.</p>
        <div class="space-y-4">
            <input id="checkPassword" type="text" class="w-full p-4 rounded-lg shadow-sm clue-input" placeholder="Enter your secret password..." />
            <button id="checkButton" class="w-full font-bold py-3 px-4 rounded-lg shadow-md btn-primary transition duration-300">
                Check Mailbox
            </button>
            <button id="showSendMailButton" class="w-full font-bold py-2 px-4 rounded-lg text-gray-500 transition duration-300 hover:bg-gray-100">
                Send a New Message
            </button>
        </div>
        <div id="replyDisplay" class="hidden mt-6 bg-pink-50 border border-pink-100 rounded-lg p-4">
            <h3 class="font-bold text-gray-700 mb-2">The reply from LCA:</h3>
            <p id="replyText" class="text-gray-900"></p>
        </div>
    </div>

    <!-- Promo Page Container -->
    <div id="promoContainer" class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full text-center hidden">
        <img src="econ.png" alt="LCA App Icon" class="w-32 h-32 rounded-3xl mx-auto shadow-lg mb-6" />
        <h1 class="text-3xl font-bold text-pink-500 mt-4 mb-2">LCA</h1>
        <h2 class="text-xl font-medium text-gray-700 mb-4">LIFE CONFESS APPLICATION</h2>
        <p class="text-lg text-gray-500 mb-8">Your anonymous mailbox awaits. ðŸ¤«</p>
        <a href="https://expo.dev/artifacts/eas/gBuM44Et2bGXaRPfPtgWuG.apk" class="block w-full font-bold py-3 px-4 rounded-lg shadow-md bg-green-600 text-white transition duration-300 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
            Download LCA App (.apk)
        </a>
    </div>

    <!-- Modals -->
    <div id="messageBox" class="hidden fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50">
        <p id="messageBoxText" class="font-medium text-center"></p>
    </div>
    <div id="adModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-2xl shadow-lg max-w-sm w-full text-center">
            <img src="econ.png" alt="LCA App Icon" class="w-24 h-24 rounded-2xl mx-auto shadow-lg mb-4 -mt-16 border-4 border-white" />
            <h3 class="text-2xl font-bold text-pink-500 mb-2">Message Sent! ðŸ’Œ</h3>
            <p id="receiptMessage" class="text-gray-500 mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm">Remember the password you just created? Use it to check for a reply later!</p>
            <p class="text-gray-600 mb-6">Want to get secret messages like this? Download the LCA app!</p>
            <button id="adDownloadButton" class="w-full font-bold py-3 px-4 rounded-lg shadow-md bg-green-600 text-white transition duration-300 mb-2 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
                Download the App
            </button>
            <button id="copyUserLinkButton" class="w-full font-bold py-3 px-4 rounded-lg shadow-md bg-blue-500 text-white transition duration-300 mb-2 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2 flex items-center justify-center hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 5a1 1 0 011-1h1V3a1 1 0 112 0v1h1a1 1 0 110 2H9a1 1 0 01-1-1z" />
                    <path fill-rule="evenodd" d="M5 3a2 2 0 012-2h6a2 2 0 012 2v1h-1V3a1 1 0 00-1-1H7a1 1 0 00-1 1v1H5V3zm5 4a1 1 0 00-1-1H5a1 1 0 00-1 1v10a1 1 0 001 1h8a1 1 0 001-1V7a1 1 0 00-1-1h-1zM6 9a1 1 0 100 2h6a1 1 0 100-2H6zm0 3a1 1 0 100 2h6a1 1 0 100-2H6z" clip-rule="evenodd" />
                </svg>
                Copy User's Link
            </button>
            <button id="adCloseButton" class="w-full font-bold py-2 px-4 rounded-lg text-gray-500 transition duration-300 hover:bg-gray-100">
                Close
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- NEW, SIMPLE, WORKING SCRIPT -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const firebaseConfig = {
                apiKey: "AIzaSyCzRIRSuwYKPdbdIrYFUV3Yuqyl0hcU0Fk",
                authDomain: "confessapp-e1aff.firebaseapp.com",
                projectId: "confessapp-e1aff",
                storageBucket: "confessapp-e1aff.firebasestorage.app",
                messagingSenderId: "1036012328977",
                appId: "1:1036012328977:web:a9df29ebf930147fe979b0"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const aiQuestions = [
                 "What's a secret you've never told anyone? ðŸ¤«", "Do you have a crush on me?",
                 "What's your biggest 'what if' in life?", "What's the last lie you told?",
                 "What's a song that reminds you of me?", "What's your most embarrassing moment?",
                 "If you could time travel, where would you go?", "What's your honest opinion of me?",
                 "What's one thing you want to do before you die?", "Do I even know you in real life? ðŸ‘€",
                 "What's a rumor you've heard about me?", "What's your biggest fear?",
                 "What do you think of my friends?", "Send me your favorite emoji.",
                 "Tell me something I don't know about you.", "Sino pinakacute sa batch natin?",
                 "May tinatago ka bang galit sakin? HAHA", "Ano ang first impression mo sakin?",
                 "Kung bibigyan mo ako ng advice, ano yun?", "Describe me in 3 words.",
                 "Ano ang pinakamalaking chismis na narinig mo lately? ðŸ˜œ", "May gusto ka bang aminin?",
                 "Anong pinaka-corny na joke ang alam mo?", "Saan mo gusto pumunta na tayong dalawa lang?",
                 "Rate my profile pic from 1-10."
            ];

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');

            const sendMailContainer = document.getElementById('sendMailContainer');
            const checkReplyContainer = document.getElementById('checkReplyContainer');
            const promoContainer = document.getElementById('promoContainer');
            
            const sendButton = document.getElementById('sendButton');
            const aiButton = document.getElementById('aiButton');
            
            const messageText = document.getElementById('messageText');
            const clueText = document.getElementById('clueText');
            const replyPassword = document.getElementById('replyPassword');
            
            const checkButton = document.getElementById('checkButton');
            const checkPassword = document.getElementById('checkPassword');
            const replyDisplay = document.getElementById('replyDisplay');
            const replyText = document.getElementById('replyText');

            const messageBox = document.getElementById('messageBox');
            const messageBoxText = document.getElementById('messageBoxText');
            
            const letterHeader = document.getElementById('letterHeader');
            const headerText = document.getElementById('headerText');
            
            const adModal = document.getElementById('adModal');
            const adDownloadButton = document.getElementById('adDownloadButton');
            const adCloseButton = document.getElementById('adCloseButton');
            const showCheckReplyButton = document.getElementById('showCheckReplyButton');
            const showSendMailButton = document.getElementById('showSendMailButton');

            const receiptMessage = document.getElementById('receiptMessage');
            const copyUserLinkButton = document.getElementById('copyUserLinkButton');
            
            // --- THIS IS THE ONLY LOGIC WE NEED FOR NOW ---
            // --- IT IS YOUR ORIGINAL, WORKING LOGIC ---
            
            let currentHeaderText = 'tell me anything';
            let currentHeaderColor = '#ffb3c6';
            let currentTheme = 'default';
            
            if (userId) {
                sendMailContainer.classList.remove('hidden');
                promoContainer.classList.add('hidden');
                checkReplyContainer.classList.add('hidden');
                
                const linkRef = db.collection("publicLinks").doc(userId);
                
                linkRef.get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        if (data.linkHeaderText) {
                            headerText.innerText = data.linkHeaderText;
                            currentHeaderText = data.linkHeaderText;
                        }
                        
                        if (data.linkHeaderColor) {
                            letterHeader.style.backgroundColor = data.linkHeaderColor;
                            currentHeaderColor = data.linkHeaderColor;
                        }
                        
                        // We will add the themes back here LATER
                        // For now, we only care about text and color
                        
                    } else { 
                        console.log("No custom link settings found."); 
                    }
                }).catch((error) => { 
                    console.error("Error getting link settings:", error); 
                });
                
            } else {
                promoContainer.classList.remove('hidden');
                sendMailContainer.classList.add('hidden');
                checkReplyContainer.classList.add('hidden');
            }

            // --- ALL OTHER CODE IS YOUR WORKING, ORIGINAL CODE ---

            aiButton.onclick = () => {
                aiButton.disabled = true;
                const aiButtonTextSpan = document.getElementById('aiButtonText');
                const aiButtonIcon = document.getElementById('aiButtonIcon');
                const aiButtonLoading = document.getElementById('aiButtonLoading');

                aiButtonTextSpan.innerText = "Thinking...";
                aiButtonIcon.classList.add('hidden');
                aiButtonLoading.classList.remove('hidden');
                
                setTimeout(() => {
                    const randomQuestion = aiQuestions[Math.floor(Math.random() * aiQuestions.length)];
                    messageText.value = randomQuestion;
                    messageText.focus();

                    aiButton.disabled = false;
                    aiButtonTextSpan.innerText = "Get AI Question";
                    aiButtonIcon.classList.remove('hidden');
                    aiButtonLoading.classList.add('hidden');
                }, 500); 
            };

            sendButton.onclick = async () => {
                if (!userId) {
                    showMessage("ERROR: No user ID found in the link.", "error");
                    return;
                }
                const text = messageText.value.trim();
                const clue = clueText.value.trim();
                const password = replyPassword.value.trim();

                if (text === "") {
                    showMessage("You can't send an empty message.", "error");
                    return;
                }
                if (password === "") {
                    showMessage("You must create a password to check for replies.", "error");
                    return;
                }
                
                const replyId = CryptoJS.SHA256(password + userId).toString();

                sendButton.disabled = true;
                sendButton.innerText = "Sending...";
                
                try {
                    const messagesRef = db.collection("users").doc(userId).collection("messages");
                    let payload = {
                        text: text, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false, hasClue: false, fromAi: false, 
                        headerText: currentHeaderText, 
                        headerColor: currentHeaderColor, 
                        theme: 'default', // We'll update this later
                        replyId: replyId
                    };
                    if (clue !== "") {
                        payload.hasClue = true;
                        payload.clueText = clue;
                    }
                    
                    await messagesRef.add(payload);
                    
                    const emoji = document.createElement('span');
                    emoji.innerHTML = 'ðŸ’Œ';
                    emoji.className = 'send-animation';
                    sendMailContainer.appendChild(emoji);
                    setTimeout(() => {
                        emoji.remove();
                    }, 2000);
                    
                    receiptMessage.innerText = `Your message: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`;
                    copyUserLinkButton.classList.remove('hidden'); 
                    adModal.classList.remove('hidden');

                    messageText.value = "";
                    clueText.value = "";
                    replyPassword.value = "";
                    
                } catch (error) {
                    console.error("Error sending message: ", error);
                    showMessage("An error occurred. Please try again.", "error");
                } finally {
                    sendButton.disabled = false;
                    sendButton.innerText = "Send Mail";
                }
            };
            
            checkButton.onclick = async () => {
                const password = checkPassword.value.trim();
                if (password === "") {
                    showMessage("Please enter your secret password.", "error");
                    return;
                }
                
                let checkingUserId = userId;
                if (!checkingUserId) {
                    const params = new URLSearchParams(window.location.search);
                    checkingUserId = params.get('id');
                    if(!checkingUserId) {
                        showMessage("Error: No user link found.", "error");
                        return;
                    }
                }
                
                const replyId = CryptoJS.SHA256(password + checkingUserId).toString();
                
                checkButton.disabled = true;
                checkButton.innerText = "Checking...";
                
                try {
                    const replyRef = db.collection("replies").doc(replyId);
                    const doc = await replyRef.get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.toUserId === checkingUserId) {
                            replyText.innerText = data.replyText;
                            replyDisplay.classList.remove('hidden');
                            showMessage("Reply found!", "success");
                        } else {
                            showMessage("Password not found for this user.", "error");
                        }
                    } else {
                        showMessage("No reply yet, or password was wrong.", "error");
                    }
                } catch (e) {
                    console.error("Error checking reply:", e);
                    showMessage("An error occurred.", "error");
                } finally {
                    checkButton.disabled = false;
                    checkButton.innerText = "Check Mailbox";
                }
            };

            showCheckReplyButton.onclick = () => {
                sendMailContainer.classList.add('hidden');
                checkReplyContainer.classList.remove('hidden');
            };
            showSendMailButton.onclick = () => {
                checkReplyContainer.classList.add('hidden');
                sendMailContainer.classList.remove('hidden');
            };
            adCloseButton.onclick = () => {
                adModal.classList.add('hidden');
            };
            adDownloadButton.onclick = () => {
                window.location.href = 'https://expo.dev/artifacts/eas/gBuM44Et2bGXaRPfPtgWuG.apk';
            };

            copyUserLinkButton.onclick = () => {
                const userLink = `https://uwuuuu4.github.io/LIFEConfess/?id=${userId}`;
                navigator.clipboard.writeText(userLink).then(() => {
                    showMessage("User's link copied to clipboard!", "success");
                }, (err) => {
                    showMessage("Failed to copy link.", "error");
                });
            };

            function showMessage(text, type) {
                messageBoxText.innerText = text;
                if (type === "success") {
                    messageBox.className = "fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 bg-green-100 text-green-800";
                } else {
                    messageBox.className = "fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 bg-red-100 text-red-800";
                }
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }
        });
    </script>
</body>
</html>
