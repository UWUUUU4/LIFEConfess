<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Late Monitoring - L.I.F.E., Inc.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            light: '#e6f4ea',
                            DEFAULT: '#10b981',
                            dark: '#047857',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        html, body { overscroll-behavior: none; height: 100%; overflow: hidden; }
        body { -webkit-tap-highlight-color: transparent; }
        #app { display: flex; flex-direction: column; height: 100dvh; }
        main { flex: 1; overflow: hidden; position: relative; }
        .page { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; background-color: #f9fafb; }
        .page.active { opacity: 1; pointer-events: auto; }
        #qr-reader-container { flex-grow: 1; position: relative; background-color: black; overflow: hidden; }
        #qr-reader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #qr-reader video { width: 100%; height: 100%; object-fit: cover; }
        .scanner-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; padding-top: 70%; border: 4px solid rgba(255, 255, 255, 0.9); border-radius: 1.5rem; box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.6); }
        .nav-button.active { background-color: #e6f4ea; color: #047857; }
        .record-item:nth-child(even) { background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="max-w-md mx-auto bg-white flex flex-col shadow-2xl">

        <header class="p-3 bg-white border-b border-gray-200 flex justify-between items-center text-sm font-semibold flex-shrink-0 z-10">
            <div class="flex items-center space-x-3">
                 <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgBwpMnrbmYVhhH615UQ-EQxzcXZ03VOo34g&s" alt="L.I.F.E., Inc. Logo" class="h-8 w-8 object-contain">
                 <h1 class="text-lg font-bold text-gray-800">LIFE Late Scanner</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div id="connection-status" class="flex items-center text-gray-500">
                    <i class="fas fa-circle text-xs mr-2"></i>
                    <span>Connecting...</span>
                </div>
            </div>
        </header>

        <main>
            <div id="page-scanner" class="page active">
                <div id="qr-reader-container">
                    <div id="qr-reader"></div>
                    <div class="scanner-box"></div>
                </div>
                 <div class="p-4 text-center flex-shrink-0 bg-gray-50 border-t">
                    <p id="scanner-message" class="text-gray-600 font-medium">Initializing...</p>
                 </div>
            </div>

            <div id="page-records" class="page p-4 overflow-y-auto bg-gray-50">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2">
                     <h1 class="text-2xl font-bold text-gray-800">Today's Late Records</h1>
                     <span id="record-count" class="text-sm font-bold bg-primary-light text-primary-dark px-3 py-1 rounded-full">0</span>
                </div>
                <div id="record-list" class="space-y-2 pb-4"></div>
            </div>

        </main>

        <nav class="grid grid-cols-2 gap-2 p-2 bg-white border-t border-gray-200 shadow-[0_-2px_5px_-1px_rgba(0,0,0,0.05)] flex-shrink-0 z-10">
            <button data-page="scanner" class="nav-button active flex flex-col items-center p-3 rounded-lg transition-colors duration-200">
                <i class="fas fa-qrcode fa-xl"></i>
                <span class="text-xs font-bold mt-1">Scan</span>
            </button>
            <button data-page="records" class="nav-button flex flex-col items-center p-3 rounded-lg text-gray-500 transition-colors duration-200">
                <i class="fas fa-list-check fa-xl"></i>
                <span class="text-xs font-bold mt-1">Records</span>
            </button>
        </nav>

        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full text-center transform transition-all scale-95 opacity-0" id="modal-content">
                <div id="modal-icon" class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4 text-white text-3xl"></div>
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                <div id="modal-details" class="text-left bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 space-y-2">
                </div>
                <button id="modal-close" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-10 rounded-lg w-full transition-transform active:scale-95">OK</button>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvBdJCbBvG9FGdSjPD61aLAa8D6JGTTkM",
            authDomain: "latemonitorinapp.firebaseapp.com",
            projectId: "latemonitorinapp",
            storageBucket: "latemonitorinapp.firebasestorage.app",
            messagingSenderId: "895673260413",
            appId: "1:895673260413:web:4235f78061575344ac5414"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {

            const pages = ['scanner', 'records'];
            const navButtons = document.querySelectorAll('.nav-button');
            let html5QrCode;
            let isProcessingScan = false;
            let currentCameraId = null; 

            function showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.toggle('active', page.id === `page-${pageId}`);
                });
                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                    btn.classList.toggle('text-gray-500', btn.dataset.page !== pageId);
                });
                if (pageId === 'scanner') startScanner();
                else stopScanner();
            }

            function showModal(title, details = {}, isSuccess = true) {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modal-content');
                const modalIcon = document.getElementById('modal-icon');
                const modalDetails = document.getElementById('modal-details');
                
                document.getElementById('modal-title').innerText = title;

                let detailsHtml = '';
                 if (details && details.name) {
                    detailsHtml += `<div class="flex justify-between text-sm"><strong class="text-gray-500">Name:</strong> <span class="font-semibold text-right">${details.name}</span></div>`;
                    detailsHtml += `<div class="flex justify-between text-sm"><strong class="text-gray-500">Student ID:</strong> <span class="font-semibold text-right">${details.id}</span></div>`;
                    detailsHtml += `<div class="flex justify-between text-sm"><strong class="text-gray-500">Course/Year:</strong> <span class="font-semibold text-right">${details.course}</span></div>`;
                    if (details.time) {
                        detailsHtml += `<div class="flex justify-between text-sm"><strong class="text-gray-500">Time Scanned:</strong> <span class="font-semibold text-right text-red-500">${details.time}</span></div>`;
                    }
                } else if (details.message) {
                    detailsHtml = `<p class="text-gray-600 text-center">${details.message}</p>`;
                }

                modalDetails.innerHTML = detailsHtml;
                modalDetails.classList.toggle('hidden', !detailsHtml);
                
                modalIcon.innerHTML = isSuccess ? '<i class="fas fa-check"></i>' : '<i class="fas fa-exclamation-triangle"></i>';
                modalIcon.className = `w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4 text-white text-3xl ${isSuccess ? 'bg-primary' : 'bg-red-500'}`;
                
                modal.classList.remove('hidden');
                setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }

            function updateStatus(isOnline) {
                const statusDiv = document.getElementById('connection-status');
                const text = statusDiv.querySelector('span');
                statusDiv.classList.toggle('text-green-500', isOnline);
                statusDiv.classList.toggle('text-red-500', !isOnline);
                text.innerText = isOnline ? 'Online' : 'Offline';
            }
            
            function startScanner() {
                document.getElementById('scanner-message').innerText = "Initializing Camera...";
                 if (isProcessingScan || (html5QrCode && html5QrCode.isScanning)) return; 
                if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader", { verbose: false });

                Html5Qrcode.getCameras().then(cameras => {
                    if (cameras && cameras.length) {
                        currentCameraId = cameras.find(c => c.label.toLowerCase().includes('back'))?.id || cameras[0].id;
                        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                        html5QrCode.start(currentCameraId, config, onScanSuccess, onScanFailure)
                           .then(() => {
                                document.getElementById('scanner-message').innerText = "Place the student's QR code inside the box.";
                            })
                           .catch(err => {
                                document.getElementById('scanner-message').innerText = "Camera permission denied.";
                            });
                    } else {
                        document.getElementById('scanner-message').innerText = "No camera found.";
                    }
                }).catch(err => {
                     document.getElementById('scanner-message').innerText = "Could not access camera.";
                });
            }

             function stopScanner() {
                if (html5QrCode) {
                    html5QrCode.stop()
                        .then(() => {
                           html5QrCode.clear();
                           document.getElementById('qr-reader').innerHTML = "";
                        })
                        .catch(err => {
                            html5QrCode.clear();
                            document.getElementById('qr-reader').innerHTML = "";
                        });
                } else {
                     document.getElementById('qr-reader').innerHTML = "";
                }
            }
            
            const onScanSuccess = (decodedText, decodedResult) => {
                if (isProcessingScan) return;
                
                if (!navigator.onLine) {
                    stopScanner();
                    showModal("Offline", { message: "PLEASE CONNECT MO SA INTERNET PARA MA SCANNED AND RECORD" }, false);
                    setTimeout(() => {
                         if (document.getElementById('page-scanner').classList.contains('active')) {
                             startScanner();
                         }
                    }, 3000);
                    return;
                }

                isProcessingScan = true;
                navigator.vibrate(100);
                try {
                    const parsedData = JSON.parse(decodedText);
                    if (!parsedData.studentId) throw new Error("Invalid QR Code");
                    handleScanData(parsedData);
                } catch (e) {
                    showModal("Scan Error", { message: "Invalid QR code format." }, false);
                    setTimeout(() => isProcessingScan = false, 2000);
                }
            };
            
            const onScanFailure = (error) => {};

            async function handleScanData(data) {
                try {
                    const scanTime = new Date();
                    const studentDoc = await db.collection('students').doc(data.studentId).get();
                    if (!studentDoc.exists) throw new Error(`Student with ID ${data.studentId} not found.`);
                    
                    const studentData = studentDoc.data();
                    const studentName = studentData.fullName;
                    const scanRecord = { studentId: data.studentId, studentName, scannedAt: scanTime.toISOString() };

                    await db.collection('attendance').add({ ...scanRecord, syncedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    
                    showModal('Scan Successful!', {
                        name: studentName,
                        id: data.studentId,
                        course: `${studentData.course} ${studentData.year}`,
                        time: scanTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })
                    }, true);

                } catch(e) {
                     showModal("Scan Error", { message: e.message }, false);
                } finally {
                    setTimeout(() => {
                        isProcessingScan = false;
                        if (document.getElementById('page-scanner').classList.contains('active')) {
                            startScanner();
                        }
                    }, 3000);
                }
            }
            
            function renderTodaysRecords() {
                const listEl = document.getElementById('record-list');
                const countEl = document.getElementById('record-count');
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                
                db.collection('attendance').where('scannedAt', '>=', todayStart).orderBy('scannedAt', 'desc')
                  .onSnapshot(snapshot => {
                    countEl.innerText = snapshot.size;
                    if (snapshot.empty) {
                        listEl.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i><p class="text-gray-500 font-medium">No late students recorded for today yet.</p></div>`;
                        return;
                    }
                    listEl.innerHTML = snapshot.docs.map(doc => {
                        const record = doc.data();
                        const scanTime = new Date(record.scannedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        return `<div class="record-item bg-white p-4 rounded-lg shadow-sm flex items-center justify-between hover:bg-gray-50" data-studentid="${record.studentId}"><div><p class="font-semibold text-lg text-gray-800">${record.studentName}</p><p class="text-gray-500 text-sm">ID: ${record.studentId}</p></div><div class="text-right"><p class="font-bold text-lg text-red-500">${scanTime}</p><p class="text-xs text-gray-400">Scanned</p></div></div>`;
                    }).join('');
                  }, error => {
                    console.error("Error fetching attendance records: ", error);
                    listEl.innerHTML = `<div class="text-center p-8 bg-red-50 text-red-700 rounded-lg shadow"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p class="font-bold">Could not load records.</p><p class="text-sm">Please check Firebase security rules.</p></div>`;
                  });
            }

            async function initApp() {
                updateStatus(navigator.onLine);
                showPage('scanner');
                renderTodaysRecords();
            }
            
            navButtons.forEach(button => button.addEventListener('click', (e) => showPage(e.currentTarget.dataset.page)));
            document.getElementById('modal-close').addEventListener('click', () => {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modal-content');
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 200);
            });
            document.getElementById('record-list').addEventListener('click', async (e) => {
                 const recordItem = e.target.closest('.record-item');
                if (recordItem) {
                    const studentId = recordItem.dataset.studentid;
                    if (!navigator.onLine) {
                        showModal('Offline', {message: 'Cannot fetch student details while offline.'}, false);
                        return;
                    }
                     try {
                        const doc = await db.collection('students').doc(studentId).get();
                         if(doc.exists) {
                            const student = doc.data();
                            showModal('Student Details', {
                                name: student.fullName,
                                id: doc.id,
                                course: `${student.course} ${student.year}`,
                            }, true);
                         } else {
                             showModal('Error', { message: 'Student details not found in database.' }, false);
                         }
                     } catch(err) {
                          showModal('Error', { message: 'Could not fetch student details.' }, false);
                     }
                }
            });
            
            window.addEventListener('online', () => updateStatus(true));
            window.addEventListener('offline', () => updateStatus(false) );

            initApp();
        });
    </script>
</body>
</html>

